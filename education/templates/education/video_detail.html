{% extends 'education/student/base_student.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.plyr.io/3.6.8/plyr.css" />
<style>
.video-player-container {
    background: #000;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.video-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.video-content {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
    margin-top: 2rem;
}

.video-info {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
}

.video-title {
    font-size: 1.5rem;
    margin: 0 0 1rem;
    color: #2d3748;
}

.video-meta {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    color: #718096;
    font-size: 0.9rem;
}

.video-meta span {
    display: flex;
    align-items: center;
    margin-right: 1.5rem;
}

.video-meta i {
    margin-right: 0.5rem;
    color: #4a6cf7;
}

.video-description {
    line-height: 1.7;
    color: #4a5568;
}

.sidebar {
    position: sticky;
    top: 100px;
    align-self: flex-start;
}

.sidebar-section {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.sidebar-title {
    font-size: 1.1rem;
    margin: 0 0 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f0f4ff;
    color: #2d3748;
    display: flex;
    align-items: center;
}

.sidebar-title i {
    margin-right: 0.5rem;
    color: #4a6cf7;
}

.related-videos {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.related-video {
    display: flex;
    gap: 1rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
    padding: 0.5rem;
    border-radius: 6px;
}

.related-video:hover {
    background: #f8f9ff;
    transform: translateX(5px);
}

.related-thumbnail {
    width: 120px;
    height: 70px;
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
    background: #f0f4ff;
    position: relative;
}

.related-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.related-thumbnail .duration {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 0.7rem;
    padding: 2px 4px;
    border-radius: 3px;
}

.related-video-info {
    flex: 1;
}

.related-video-title {
    font-size: 0.9rem;
    margin: 0 0 0.3rem;
    color: #2d3748;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.related-video-teacher {
    font-size: 0.8rem;
    color: #718096;
    margin: 0 0 0.3rem;
}

.related-video-stats {
    font-size: 0.75rem;
    color: #a0aec0;
    display: flex;
    gap: 0.8rem;
}

.notes-list {
    margin: 0;
    padding: 0;
    list-style: none;
}

.note-item {
    padding: 1rem 0;
    border-bottom: 1px solid #f0f4ff;
}

.note-item:last-child {
    border-bottom: none;
}

.note-title {
    font-weight: 600;
    margin: 0 0 0.5rem;
    color: #2d3748;
    display: flex;
    align-items: center;
}

.note-title i {
    margin-right: 0.5rem;
    color: #4a6cf7;
}

.note-content {
    font-size: 0.9rem;
    color: #4a5568;
    line-height: 1.6;
    margin: 0 0 0.5rem;
}

.note-meta {
    font-size: 0.8rem;
    color: #a0aec0;
    display: flex;
    align-items: center;
}

.note-meta i {
    margin-right: 0.3rem;
}

.download-note {
    display: inline-flex;
    align-items: center;
    color: #4a6cf7;
    text-decoration: none;
    font-size: 0.9rem;
    margin-top: 0.5rem;
    transition: color 0.2s ease;
}

.download-note:hover {
    color: #3a5bd9;
}

.download-note i {
    margin-right: 0.5rem;
}

/* Responsive Styles */
@media (max-width: 992px) {
    .video-content {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        position: static;
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .video-meta {
        flex-wrap: wrap;
        gap: 0.8rem;
    }
    
    .video-meta span {
        margin-right: 0.8rem;
    }
    
    .related-video {
        flex-direction: column;
    }
    
    .related-thumbnail {
        width: 100%;
        height: 180px;
    }
}

@media (max-width: 576px) {
    .video-detail-container {
        padding: 1rem 0.5rem;
    }
    
    .video-info {
        padding: 1rem;
    }
    
    .video-title {
        font-size: 1.3rem;
    }
}
</style>
{% endblock %}

{% block student_content %}
<div class="video-detail-container">
    <!-- Video Player -->
    <div class="video-player-container">
        <video id="player" playsinline controls data-poster="{{ video.thumbnail.url|default:'' }}">
            <source src="{{ video.video_file.url }}" type="video/mp4" />
            Your browser does not support the video tag.
        </video>
    </div>
    
    <div class="video-content">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Video Info -->
            <div class="video-info">
                <h1 class="video-title">{{ video.title }}</h1>
                <div class="video-meta">
                    <span><i class="fas fa-eye"></i> {{ video.view_count }} views</span>
                    <span><i class="far fa-calendar-alt"></i> {{ video.created_at|date:"F j, Y" }}</span>
                    <span><i class="fas fa-user-tie"></i> 
                        <a href="{% url 'teacher_profile' video.teacher.id %}" class="text-link">
                            {{ video.teacher.get_full_name|default:video.teacher.username }}
                        </a>
                    </span>
                    {% if video.subject %}
                    <span><i class="fas fa-book"></i> {{ video.subject.name }}</span>
                    {% endif %}
                </div>
                
                {% if video.description %}
                <div class="video-description">
                    {{ video.description|linebreaks }}
                </div>
                {% endif %}
            </div>
            
            <!-- Notes Section -->
            {% if notes %}
            <div class="notes-section">
                <h2 class="section-title">Notes & Resources</h2>
                <ul class="notes-list">
                    {% for note in notes %}
                    <li class="note-item">
                        <h3 class="note-title">
                            <i class="fas fa-file-alt"></i> {{ note.title }}
                        </h3>
                        {% if note.content %}
                        <div class="note-content">
                            {{ note.content|linebreaks }}
                        </div>
                        {% endif %}
                        {% if note.file %}
                        <a href="{{ note.file.url }}" class="download-note" download>
                            <i class="fas fa-download"></i> Download File
                        </a>
                        {% endif %}
                        <div class="note-meta">
                            <span><i class="far fa-calendar"></i> {{ note.updated_at|date:"M d, Y" }}</span>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Related Videos -->
            {% if related_videos %}
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <i class="fas fa-play-circle"></i> More Videos
                </h3>
                <div class="related-videos">
                    {% for related in related_videos %}
                    <a href="{% url 'video_detail' related.id %}" class="related-video">
                        <div class="related-thumbnail">
                            {% if related.thumbnail %}
                                <img src="{{ related.thumbnail.url }}" alt="{{ related.title }}">
                            {% endif %}
                            <span class="duration">{{ related.duration|time:"i:s"|default:'00:00' }}</span>
                        </div>
                        <div class="related-video-info">
                            <h4 class="related-video-title">{{ related.title|truncatechars:60 }}</h4>
                            <div class="related-video-teacher">
                                {{ related.teacher.get_full_name|default:related.teacher.username }}
                            </div>
                            <div class="related-video-stats">
                                <span><i class="far fa-eye"></i> {{ related.view_count }}</span>
                                <span><i class="far fa-calendar-alt"></i> {{ related.created_at|date:"M d" }}</span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- About Teacher -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <i class="fas fa-chalkboard-teacher"></i> About Instructor
                </h3>
                <div class="teacher-card">
                    <div class="teacher-header">
                        {% if video.teacher.teacher_profile.profile_picture %}
                            <img src="{{ video.teacher.teacher_profile.profile_picture.url }}" alt="{{ video.teacher.get_full_name }}" class="teacher-avatar">
                        {% else %}
                            <div class="default-avatar">
                                <i class="fas fa-user-tie"></i>
                            </div>
                        {% endif %}
                        <div class="teacher-info">
                            <h4>{{ video.teacher.get_full_name|default:video.teacher.username }}</h4>
                            {% if video.teacher.teacher_profile.qualification %}
                                <p class="teacher-qualification">{{ video.teacher.teacher_profile.qualification }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{% url 'teacher_profile' video.teacher.id %}" class="btn btn-outline btn-block" style="margin-top: 1rem;">
                        View Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Plyr Video Player -->
<script src="https://cdn.plyr.io/3.6.8/plyr.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Plyr video player
    const player = new Plyr('#player', {
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
        ratio: '16:9',
        autoplay: false,
        keyboard: { focused: true, global: true }
    });
    
    // Handle video play event to track views
    player.on('play', () => {
        // You can add analytics here to track video plays
        console.log('Video started playing');
    });
    
    // Handle video ended event
    player.on('ended', () => {
        // You can add completion tracking here
        console.log('Video finished playing');
    });
});
</script>
{% endblock %}
